#!/usr/bin/python3
from NgenExceptions import *
from pyngen import PyNgen
import os
import sys
import click


print("asd")

NGEN_CONFIG_DIR = '~/.ngen/'
COLORIZE_FIELDS = {
    'ip_str': 'green',
    'port': 'yellow',
    'data': 'white',
    'hostnames': 'magenta',
    'org': 'cyan',
    'vulns': 'red',
}


@main.command()
@click.argument('url', metavar='<ngen url>')
@click.argument('key', metavar='<api key>')
def init(url, key):
    """Initialize the Ngen command-line"""
    # Create the directory if necessary
    ngen_dir = os.path.expanduser(NGEN_CONFIG_DIR)
    if not os.path.isdir(ngen_dir):
        try:
            os.mkdir(ngen_dir)
        except OSError:
            raise click.ClickException(
                'Unable to create directory to store the Ngen API key ({})'.format(ngen_dir))

    # Make sure it's a valid API key
    key = key.strip()
    try:
        api = PyNgen(url, key)
        # api.info()
    except UnauthorizedNgenError as e:
        raise click.ClickException(e.detail)

    # Store the API key in the user's directory
    keyfile = ngen_dir + '/api_key'
    with open(keyfile, 'w') as fout:
        fout.write(key.strip())
        click.echo(click.style('Successfully initialized', fg='green'))

    os.chmod(keyfile, 0o600)


def createNewIncident(pyngen, address, incident_feed, incident_type, **kargs):
    try:
        res = pyngen.newIncident(address, incident_feed, incident_type)
        print("Created incident with ID: {}".format(res))
    except NewIncidentFieldError as e:
        print("Error creating incident: \n{}".format(e.detail))
        exit(2)
